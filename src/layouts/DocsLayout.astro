---
import Base from './Base.astro';
import { getCollection } from 'astro:content';

export interface Props {
  title: string;
  description?: string;
  currentSlug?: string;
  pageTitle?: string;
  subtitle?: string;
}

const { title, description, currentSlug, pageTitle, subtitle } = Astro.props;

// Get all published docs, grouped by section
const allDocs = (await getCollection('docs'))
  .filter((doc) => !doc.data.draft)
  .sort((a, b) => a.data.order - b.data.order);

// Group by section
const sections = allDocs.reduce((acc, doc) => {
  const section = doc.data.section;
  if (!acc[section]) acc[section] = [];
  acc[section].push(doc);
  return acc;
}, {} as Record<string, typeof allDocs>);

const sectionOrder = ['Getting Started', 'Core Concepts', 'Features', 'Advanced', 'Reference'];
const orderedSections = sectionOrder.filter(s => sections[s]);

const currentDoc = currentSlug ? allDocs.find((doc) => doc.slug === currentSlug) : null;
const displayTitle = pageTitle ?? currentDoc?.data.title ?? (title.includes(' — ') ? title.split(' — ')[0] : title);
const displaySubtitle = subtitle ?? description ?? 'Readable, higher-contrast docs for the Echolia mind-room.';
const docSection = currentDoc?.data.section ?? 'Documentation';
---

<Base title={title} description={description}>
  <div class="flex min-h-[calc(100vh-10rem)] docs-shell">
    <!-- Sidebar Navigation -->
    <aside class="hidden lg:block w-72 border-r border-white/5 bg-bg-surface/40 sticky top-[64px] self-start max-h-[calc(100vh-64px)] overflow-y-auto backdrop-blur">
      <nav class="p-6 space-y-7">
        <div>
          <a href="/docs" class="block mb-4">
            <h2 class="text-[11px] font-mono uppercase tracking-[0.3em] text-text-muted opacity-70">Documentation</h2>
          </a>
        </div>

        {orderedSections.map((sectionName) => (
          <div class="space-y-2">
            <h3 class="text-[11px] font-mono uppercase tracking-[0.25em] text-accent-cyan/80 mb-3">
              {sectionName}
            </h3>
            <ul class="space-y-1.5">
              {sections[sectionName].map((doc) => (
                <li>
                  <a
                    href={`/docs/${doc.slug}/`}
                    class:list={[
                      'block px-3 py-2 text-sm rounded-md transition-all border border-transparent',
                      currentSlug === doc.slug
                        ? 'bg-accent-cyan/10 text-text-main border-accent-cyan/60 shadow-[0_0_0_1px_rgba(125,227,218,0.18)]'
                        : 'text-text-muted hover:text-text-main hover:bg-white/5 hover:border-white/10'
                    ]}
                  >
                    {doc.data.title}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 px-6 md:px-10 lg:px-16 py-10 md:py-14 max-w-5xl">
      <div class="thought-card doc-hero">
        <div class="space-y-4">
          <p class="doc-eyebrow">Docs • {docSection}</p>
          <h1 class="doc-headline">{displayTitle}</h1>
          <p class="doc-subtitle">
            {displaySubtitle}
          </p>
        </div>
        <div class="doc-actions">
          <a href="/download" class="doc-ghost">Download</a>
          <a href="mailto:support@echolia.app" class="doc-ghost doc-ghost-secondary">Need help?</a>
        </div>
      </div>

      <!-- Mobile section selector -->
      <div class="lg:hidden mb-6">
        <select
          class="w-full px-4 py-2 bg-bg-surface border border-white/10 rounded-md text-sm text-text-main"
          onchange="window.location.href = this.value"
        >
          <option value="">Navigate to...</option>
          {orderedSections.map((sectionName) => (
            <optgroup label={sectionName}>
              {sections[sectionName].map((doc) => (
                <option
                  value={`/docs/${doc.slug}/`}
                  selected={currentSlug === doc.slug}
                >
                  {doc.data.title}
                </option>
              ))}
            </optgroup>
          ))}
        </select>
      </div>

      <div class="thought-card doc-article">
        <article class="prose-echolia">
          <slot />
        </article>
      </div>
    </div>
  </div>
</Base>

<style>
  /* Custom prose styling for docs */
  :global(.prose-echolia) {
    @apply text-text-main leading-[1.8];
    font-family: var(--font-reading);
    font-size: 18px;
    max-width: 68ch;
  }

  :global(.prose-echolia h1) {
    @apply text-3xl md:text-4xl font-semibold text-text-main mb-5 mt-0;
    font-family: var(--font-sans);
    line-height: 1.2;
  }

  :global(.prose-echolia h2) {
    @apply text-2xl md:text-3xl font-semibold text-text-main mb-4 mt-12 pb-3 border-b border-white/15;
    font-family: var(--font-sans);
    line-height: 1.3;
  }

  :global(.prose-echolia h3) {
    @apply text-xl md:text-2xl font-semibold text-text-main mb-3 mt-8;
    font-family: var(--font-sans);
    line-height: 1.35;
  }

  :global(.prose-echolia h4) {
    @apply text-lg md:text-xl font-semibold text-text-main mb-3 mt-6;
    font-family: var(--font-sans);
    line-height: 1.4;
  }

  :global(.prose-echolia p) {
    @apply text-text-main mb-6;
    line-height: 1.8;
  }

  :global(.prose-echolia a) {
    @apply text-accent-cyan hover:text-accent-pink transition-colors underline decoration-1;
    text-decoration-color: rgba(125, 227, 218, 0.5);
    text-underline-offset: 3px;
  }

  :global(.prose-echolia a:hover) {
    text-decoration-color: rgba(255, 92, 157, 0.6);
  }

  :global(.prose-echolia ul, .prose-echolia ol) {
    @apply text-text-main mb-6;
    line-height: 1.8;
  }

  :global(.prose-echolia ul) {
    @apply space-y-3;
    padding-left: 1.5em;
  }

  :global(.prose-echolia ol) {
    @apply space-y-3;
    padding-left: 1.5em;
  }

  :global(.prose-echolia li) {
    line-height: 1.75;
  }

  :global(.prose-echolia li > ul, .prose-echolia li > ol) {
    @apply mt-3 mb-2;
  }

  :global(.prose-echolia code) {
    @apply font-mono bg-bg-alt px-2.5 py-1 rounded-md border border-white/15;
    font-size: 15px;
    color: rgba(125, 227, 218, 0.95);
  }

  :global(.prose-echolia pre) {
    @apply bg-[#0A0F1A] border border-white/15 rounded-xl p-5 overflow-x-auto mb-6;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), var(--glow-ambient);
    line-height: 1.6;
  }

  :global(.prose-echolia pre code) {
    @apply bg-transparent border-0 p-0 text-text-main;
    font-size: 15px;
  }

  :global(.prose-echolia blockquote) {
    @apply border-l-2 pl-5 italic my-6 bg-bg-alt/50 rounded-xl border border-white/15 py-4 pr-5;
    border-left-color: rgba(125, 227, 218, 0.6);
    line-height: 1.75;
  }

  :global(.prose-echolia strong) {
    @apply font-semibold text-text-main;
  }

  :global(.prose-echolia img) {
    @apply rounded-lg border border-white/10 my-8;
  }

  /* Shell */
  :global(.docs-shell) {
    background: linear-gradient(145deg, rgba(9, 12, 20, 0.65), rgba(20, 27, 41, 0.75));
  }

  :global(.doc-hero) {
    @apply flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-8;
  }

  :global(.doc-eyebrow) {
    @apply text-[11px] font-mono uppercase tracking-[0.35em] text-text-muted opacity-70;
    letter-spacing: 0.35em;
  }

  :global(.doc-headline) {
    @apply text-3xl md:text-4xl font-semibold text-text-main leading-tight;
  }

  :global(.doc-subtitle) {
    @apply text-base md:text-lg text-text-muted leading-relaxed max-w-2xl;
  }

  :global(.doc-actions) {
    @apply flex flex-wrap gap-3 md:justify-end;
  }

  :global(.doc-ghost) {
    @apply inline-flex items-center gap-2 text-sm px-4 py-2 rounded-full border transition-all duration-200;
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.12);
    color: var(--color-text-primary);
  }

  :global(.doc-ghost:hover) {
    border-color: rgba(125, 227, 218, 0.5);
    box-shadow: var(--glow-direct);
  }

  :global(.doc-ghost-secondary) {
    background: rgba(255, 92, 157, 0.08);
    border-color: rgba(255, 92, 157, 0.25);
  }

  :global(.doc-article) {
    @apply border border-white/15 bg-bg-surface/90 p-8 md:p-10;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  }

  /* OS tabs on installation page (Radix Tabs) */
  :global(.os-tabs) {
    @apply mt-4 mb-6;
  }

  :global(.os-tab-list) {
    @apply inline-flex items-center gap-2 bg-bg-surface border border-[var(--card-border)] rounded-full p-1;
  }

  :global(.os-trigger) {
    @apply inline-flex items-center gap-2 px-4 py-1.5 text-sm text-text-muted rounded-full transition-all duration-200;
    background: transparent;
  }

  :global(.os-trigger[data-state="active"]) {
    @apply bg-bg-alt text-text-main;
    box-shadow: var(--glow-ambient);
  }

  :global(.os-tab-icon) {
    @apply text-base;
  }
</style>
