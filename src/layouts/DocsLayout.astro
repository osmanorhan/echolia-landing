---
import Base from './Base.astro';
import { getCollection } from 'astro:content';

export interface Props {
  title: string;
  description?: string;
  currentSlug?: string;
}

const { title, description, currentSlug } = Astro.props;

// Get all published docs, grouped by section
const allDocs = (await getCollection('docs'))
  .filter((doc) => !doc.data.draft)
  .sort((a, b) => a.data.order - b.data.order);

// Group by section
const sections = allDocs.reduce((acc, doc) => {
  const section = doc.data.section;
  if (!acc[section]) acc[section] = [];
  acc[section].push(doc);
  return acc;
}, {} as Record<string, typeof allDocs>);

const sectionOrder = ['Getting Started', 'Core Concepts', 'Features', 'Advanced', 'Reference'];
const orderedSections = sectionOrder.filter(s => sections[s]);
---

<Base title={title} description={description}>
  <div class="flex min-h-[calc(100vh-10rem)]">
    <!-- Sidebar Navigation -->
    <aside class="hidden lg:block w-64 border-r border-white/5 bg-bg-surface/30 sticky top-[64px] self-start max-h-[calc(100vh-64px)] overflow-y-auto">
      <nav class="p-6 space-y-6">
        <div>
          <a href="/docs" class="block mb-4">
            <h2 class="text-sm font-mono uppercase tracking-[0.2em] text-text-muted/60">Documentation</h2>
          </a>
        </div>

        {orderedSections.map((sectionName) => (
          <div class="space-y-2">
            <h3 class="text-xs font-mono uppercase tracking-[0.2em] text-accent-pink/70 mb-3">
              {sectionName}
            </h3>
            <ul class="space-y-1.5">
              {sections[sectionName].map((doc) => (
                <li>
                  <a
                    href={`/docs/${doc.slug}/`}
                    class:list={[
                      'block px-3 py-1.5 text-sm rounded-md transition-all',
                      currentSlug === doc.slug
                        ? 'bg-accent-pink/10 text-text-main border-l-2 border-accent-pink'
                        : 'text-text-muted hover:text-text-main hover:bg-white/5'
                    ]}
                  >
                    {doc.data.title}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 px-4 md:px-8 lg:px-12 py-8 md:py-12 max-w-4xl">
      <!-- Mobile section selector -->
      <div class="lg:hidden mb-6">
        <select
          class="w-full px-4 py-2 bg-bg-surface border border-white/10 rounded-md text-sm text-text-main"
          onchange="window.location.href = this.value"
        >
          <option value="">Navigate to...</option>
          {orderedSections.map((sectionName) => (
            <optgroup label={sectionName}>
              {sections[sectionName].map((doc) => (
                <option
                  value={`/docs/${doc.slug}/`}
                  selected={currentSlug === doc.slug}
                >
                  {doc.data.title}
                </option>
              ))}
            </optgroup>
          ))}
        </select>
      </div>

      <article class="prose-echolia">
        <slot />
      </article>
    </div>
  </div>
</Base>

<style>
  /* Custom prose styling for docs */
  :global(.prose-echolia) {
    @apply text-text-main;
  }

  :global(.prose-echolia h1) {
    @apply text-3xl md:text-4xl font-semibold text-text-main mb-4 mt-0;
  }

  :global(.prose-echolia h2) {
    @apply text-2xl md:text-3xl font-semibold text-text-main mb-3 mt-8 pb-2 border-b border-white/5;
  }

  :global(.prose-echolia h3) {
    @apply text-xl md:text-2xl font-medium text-text-main mb-2 mt-6;
  }

  :global(.prose-echolia p) {
    @apply text-sm md:text-base text-text-muted leading-relaxed mb-4;
  }

  :global(.prose-echolia a) {
    @apply text-accent-pink hover:text-accent-cyan transition-colors underline;
    text-decoration-color: rgba(255, 62, 142, 0.3);
  }

  :global(.prose-echolia a:hover) {
    text-decoration-color: rgba(76, 215, 208, 0.5);
  }

  :global(.prose-echolia ul, .prose-echolia ol) {
    @apply text-sm md:text-base text-text-muted space-y-2 mb-4;
  }

  :global(.prose-echolia li) {
    @apply leading-relaxed;
  }

  :global(.prose-echolia code) {
    @apply font-mono text-xs md:text-sm bg-bg-surface px-2 py-0.5 rounded border border-white/5 text-accent-cyan;
  }

  :global(.prose-echolia pre) {
    @apply bg-bg-surface border border-white/5 rounded-lg p-4 overflow-x-auto mb-4;
  }

  :global(.prose-echolia pre code) {
    @apply bg-transparent border-0 p-0 text-text-muted;
  }

  :global(.prose-echolia blockquote) {
    @apply border-l-2 pl-4 italic text-text-muted my-4;
    border-color: rgba(255, 62, 142, 0.4);
    opacity: 0.9;
  }

  :global(.prose-echolia strong) {
    @apply font-semibold text-text-main;
  }

  :global(.prose-echolia img) {
    @apply rounded-lg border border-white/5 my-6;
  }
</style>
